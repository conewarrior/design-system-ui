# Token Change Check Workflow
# tokens.css에서 토큰명이 변경/삭제되면 경고 및 PR 코멘트 추가
# Breaking Change 방지를 위한 안전장치

name: Token Change Check

on:
  pull_request:
    paths:
      - 'tokens.css'

jobs:
  check-token-changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get base branch tokens
        run: |
          git show origin/${{ github.base_ref }}:tokens.css > /tmp/tokens-base.css 2>/dev/null || echo "" > /tmp/tokens-base.css

      - name: Extract and compare token names
        id: check
        run: |
          # 토큰명 추출 함수 (--로 시작하는 CSS 변수명)
          extract_tokens() {
            grep -oE '--[a-zA-Z0-9-]+' "$1" | sort -u
          }

          # Base와 PR 브랜치에서 토큰 추출
          extract_tokens /tmp/tokens-base.css > /tmp/tokens-base-names.txt
          extract_tokens tokens.css > /tmp/tokens-pr-names.txt

          # 삭제된 토큰 찾기 (base에 있지만 PR에 없는 것)
          REMOVED=$(comm -23 /tmp/tokens-base-names.txt /tmp/tokens-pr-names.txt)

          # 추가된 토큰 찾기 (PR에 있지만 base에 없는 것)
          ADDED=$(comm -13 /tmp/tokens-base-names.txt /tmp/tokens-pr-names.txt)

          # 결과 저장
          echo "removed<<EOF" >> $GITHUB_OUTPUT
          echo "$REMOVED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "added<<EOF" >> $GITHUB_OUTPUT
          echo "$ADDED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # 삭제된 토큰이 있으면 warning 플래그
          if [ -n "$REMOVED" ]; then
            echo "has_breaking_change=true" >> $GITHUB_OUTPUT
          else
            echo "has_breaking_change=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR (Breaking Change Warning)
        if: steps.check.outputs.has_breaking_change == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const removed = `${{ steps.check.outputs.removed }}`.trim().split('\n').filter(Boolean);
            const added = `${{ steps.check.outputs.added }}`.trim().split('\n').filter(Boolean);

            let body = `## ⚠️ Token Change Detected

            ### 삭제된 토큰 (Breaking Change)
            이 토큰들이 삭제되면 사용 중인 프로젝트에서 스타일이 깨질 수 있습니다.

            ${removed.map(t => `- \`${t}\``).join('\n')}

            ### 조치 필요
            1. 삭제 전에 사용 중인 프로젝트가 없는지 확인하세요
            2. 대체 토큰이 있다면 마이그레이션 가이드를 작성하세요
            3. 모든 프로젝트 업데이트 후 삭제하세요

            ---
            ${added.length > 0 ? `### 추가된 토큰\n${added.map(t => `- \`${t}\``).join('\n')}` : ''}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Comment on PR (Safe Changes)
        if: steps.check.outputs.has_breaking_change == 'false' && steps.check.outputs.added != ''
        uses: actions/github-script@v7
        with:
          script: |
            const added = `${{ steps.check.outputs.added }}`.trim().split('\n').filter(Boolean);

            if (added.length > 0) {
              const body = `## ✅ Token Changes (Safe)

              ### 추가된 토큰
              ${added.map(t => `- \`${t}\``).join('\n')}

              삭제된 토큰이 없으므로 Breaking Change 위험이 없습니다.
              `;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }

      - name: Fail on Breaking Change (Optional)
        if: steps.check.outputs.has_breaking_change == 'true'
        run: |
          echo "::warning::Breaking Change detected! Tokens were removed from tokens.css"
          echo "Removed tokens:"
          echo "${{ steps.check.outputs.removed }}"
          # 원하면 아래 주석을 해제하여 PR을 실패시킬 수 있음
          # exit 1
